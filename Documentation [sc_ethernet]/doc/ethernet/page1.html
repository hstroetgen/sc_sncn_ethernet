

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Ethernet Mac Description &mdash; XMOS Layer 2 Ethernet MAC Component v documentation</title>

    <link rel="stylesheet" href=".static/pygments.css" type="text/css" />
    <link rel="stylesheet" href=".static/globals.css"  type="text/css" />
    <link rel="stylesheet" href=".static/ui.css" type="text/css" />
    <link rel="stylesheet" href=".static/app.css"  type="text/css" />
    <link rel="stylesheet" href=".static/mobile.css"  type="text/css" />
    <link rel="stylesheet" href=".static/xde.css"
    type="text/css" /><script type="text/javascript" src=".static/scripts.js"></script>
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src=".static/jquery.js"></script>
    <script type="text/javascript" src=".static/underscore.js"></script>
    <script type="text/javascript" src=".static/doctools.js"></script>
    <link rel="top" title="XMOS Layer 2 Ethernet MAC Component v documentation" href="index.html" />
    <link rel="next" title="Ethernet Programming Guide" href="page2.html" />
    <link rel="prev" title="Ethernet Layer 2 MAC Overview" href="page0.html" /> 
  </head>
  <body class="xde indented-content" onload="prepareContents();">  
          <div id="body">
             <div id="content">
             <h1>Ethernet Mac Description</h1>

             <div class='columns'>
            
  <p>The ethernet MAC runs on two or five logical cores depending on the
chosen implementation and communicates to client
tasks over channels. The server
can connect to several clients and each channel connection to the
server is for either RX (receiving packets from the MAC) or TX
(transmitting packets to the MAC) operation.</p>
<div class="figure">
<div class="caption"><span>MAC component (FULL implementation)</span></div>
<img alt="_images/mac.png" src="_images/mac.png" style="width: 100%;" />
</div>
<h2 class="topic" id="full-implementation">FULL Implementation</h2>
<div><h3 id="buffers-and-queues">Buffers and Queues</h3>
<div><p>The MAC maintains a two sets of buffers: one for incoming packets and
one for outgoing packets. These buffers are arranged into several
queues.</p>
<p>Incoming buffers move around the different queues as follows:</p>
<blockquote>
<div><ul>
<li>Empty buffers are in the incoming queue awaiting a packet coming
in from the MII interfaces</li>
<li>Buffers received from the MII interface are filtered (see below)
and if they need to be kept then are moved into a forwarding
queue.</li>
<li>Buffers in the forwarding queue are moved into a client queue
depending on which client registered for that type of
packet.</li>
<li>Once the data from a buffer has been sent to a client the buffer
is moved back into the incoming queue.</li>
</ul>
</div></blockquote>
<p>Outgoing buffers move around the different queues as follows:</p>
<blockquote>
<div><ul>
<li>Empty buffers are an empty queue awaiting a packet coming
in from a client.</li>
<li>Once the data is received the buffer is moved into a transmit
queue awaiting output on the MII interface.</li>
<li>Once the data is transmitted, the buffer is released back to the
empty queue.</li>
</ul>
</div></blockquote>
<p>The number of buffers available can be set in the <tt class="docutils literal"><span class="pre">ethernet_conf.h</span></tt>
configuration file (see <a class="reference" href="page3.html#sec-conf-defines"><span>Configuration Defines</span></a>).</p>
</div><h3 id="filtering">Filtering</h3>
<div><p>After incoming packets are received they are filtered. An initial
filter is done where the packet is dropped unless:</p>
<blockquote>
<div><ol class="arabic simple">
<li>The packet is destined for the host&#8217;s MAC address or</li>
<li>The packet is destined for a MAC address with the broadcast bit
set</li>
</ol>
</div></blockquote>
<p>After this initial filter, a user filter is supplied. To maintain the
maximum amount of flexibility and efficiency the application must
supply custom code to perform this filtering.</p>
<p>The user must supply a definition of the function
<a class="reference" href="page3.html#mac_custom_filter" title="mac_custom_filter"><span>mac_custom_filter()</span></a>. This function can inspect incoming
packets in any manner suitable for applications and then returns
either 0 if the packet is to be dropped or a number which the clients
can then use to determine which packets they wish to receive (using
the client function <a class="reference" href="page3.html#mac_set_custom_filter" title="mac_set_custom_filter"><span>mac_set_custom_filter()</span></a>.</p>
</div><h3 id="timestamping">Timestamping</h3>
<div><p>On receipt of a ethernet frame over MII a timestamp is taken of the
100Mhz reference timer on the core that the ethernet server is
running on. The timestamp is taken at the end of the preamble
immediately before the frame itself. This timestamp will be accurate
to within 40ns. The timestamp is stored with the buffer data and can
be retrieved by the client by using the <a class="reference" href="page3.html#mac_rx_timed" title="mac_rx_timed"><span>mac_rx_timed()</span></a> function.</p>
<p>On transmission of a ethernet frame over MII a timestamp is also
taken. The timestamp is also taken at the end of the preamble
immediately before the frame itself and is accurate to within 40ns.
The client can retreive the timestamp using the <a class="reference" href="page3.html#mac_tx_timed" title="mac_tx_timed"><span>mac_tx_timed()</span></a>
function. In this case the timestamp is stored on transmission and
placed in a queue to be sent back to the client thread.</p>
</div></div><h2 class="topic" id="lite-implementation">LITE implementation</h2>
<div><p>The LITE implementation does not support timestamping or multiple
queues/buffering. The MAC will filter packets based on MAC address and
the broadcast bit of the incoming MAC address. Any further filtering
must be done by the single receive client of the ethernet server.</p>
</div><h2 class="topic" id="mac-address-storage">MAC Address Storage</h2>
<div><p>The MAC address used for the server is set on instantiation of the
server (as an argument to the <a class="reference" href="page3.html#ethernet_server" title="ethernet_server"><span>ethernet_server()</span></a> function).
This address should be unique for each device. For all XMOS develop
boards, a unique mac address is stored in the one time programmable
rom (OTP). To retreive this address <tt class="docutils literal"><span class="pre">otp_board_info_get_mac</span></tt>
function is provided in the module <tt class="docutils literal"><span class="pre">module_otp_board_info</span></tt>.</p>
<p>For information on programming MAC addresses into OTP please contact
XMOS for detalis.</p>
</div>

             </div>
             </div>


          </div>

          <div>
             <!--seealsos-->
          </div><div id="local_seealso">
             <h1>See Also</h1>
             <ul class="iconmenu">
             <li><a href="page0.html">Ethernet Layer 2 MAC Overview</a></li>
             <li><a href="page2.html">Ethernet Programming Guide</a></li>
             <li><a href="page3.html">Ethernet API</a></li>
             <li><a href="page4.html">SMI Component API</a></li>
             <li><a href="page5.html">XMOS Development Board Support Component</a></li>
             </ul>
          </div>
    <div class="footer">
    </div>
  </body>
</html>